<!DOCTYPE html>
<html lang="es" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BJJ Trader Pro</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
    
    <!-- Trading Libraries -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    
    <style>
      :root {
        --tv-bg: #131722;
        --tv-card: #1e222d;
        --tv-border: #2a2e39;
        --tv-green: #26a69a;
        --tv-red: #ef5350;
        --tv-blue: #2962ff;
      }

      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--tv-bg);
        color: #d1d4dc;
      }

      /* Custom Scrollbar */
      html, body { overflow-x: hidden; } /* Prevent horizontal scroll */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: var(--tv-bg); }
      ::-webkit-scrollbar-thumb { background: #363a45; border-radius: 3px; }

      /* Components Override */
      .navbar { background-color: var(--tv-card); border-bottom: 1px solid var(--tv-border); }
      .card { background-color: var(--tv-card); border: 1px solid var(--tv-border); }
      .btn-outline-secondary { border-color: var(--tv-border); color: #b2b5be; }
      .btn-outline-secondary:hover { background-color: var(--tv-border); color: #fff; }

      /* Symbol Scroller */
      .symbol-scroller {
        display: flex;
        overflow-x: auto;
        gap: 0.5rem;
        padding: 0.5rem 0;
        scrollbar-width: none; /* Firefox */
      }
      .symbol-scroller::-webkit-scrollbar { display: none; }
      
      .symbol-btn {
        white-space: nowrap;
        border: 1px solid var(--tv-border);
        background: var(--tv-bg);
        color: #b2b5be;
        padding: 0.35rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s;
      }
      .symbol-btn:hover { border-color: #5d606b; color: #fff; }
      .symbol-btn.active {
        background-color: var(--tv-blue); /* Bootstrap Primary */
        border-color: var(--tv-blue);
        color: white;
      }

      /* Chart Container */
      .chart-container {
        height: 60vh; /* Default height */
        position: relative;
        border-radius: 8px;
        overflow: hidden;
      }
      @media (min-width: 992px) {
        .chart-container { height: 75vh; }
      }

      /* Indicator Cards */
      .indicator-value { font-size: 1.5rem; font-weight: 700; letter-spacing: -1px; }
      .indicator-label { text-transform: uppercase; font-size: 0.7rem; color: #787b86; font-weight: 600; }
      
      /* Alerts Feed */
      .alerts-feed {
        max-height: 400px;
        overflow-y: auto;
      }
      .alert-item {
        border-left: 3px solid transparent;
        background: rgba(42, 46, 57, 0.5);
        margin-bottom: 0.5rem;
        transition: transform 0.2s;
      }
      .alert-item:hover { transform: translateX(2px); }
      .alert-item.buy { border-left-color: var(--tv-green); }
      .alert-item.sell { border-left-color: var(--tv-red); }
      
      /* Mobile Optimization */
      @media (max-width: 768px) {
        .chart-container { 
          height: 70vh; /* Maximize chart space on mobile */
        }
        .indicator-value { font-size: 1.25rem; }
        .navbar-brand { font-size: 1.1rem; }
      }

      /* Status Dot */
      .status-dot {
        height: 8px; width: 8px; 
        background-color: #ef5350; 
        border-radius: 50%; 
        display: inline-block;
        box-shadow: 0 0 5px rgba(239, 83, 80, 0.5);
      }
      .status-dot.connected { 
        background-color: #26a69a; 
        box-shadow: 0 0 5px rgba(38, 166, 154, 0.5); 
      }
      
      /* Floating Telegram Button (Mobile) */
      .fab-telegram {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        background-color: #229ED9;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        transition: transform 0.2s;
      }
      .fab-telegram:active { transform: scale(0.95); }
    </style>
  </head>
  <body>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg sticky-top">
      <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center gap-2" href="#">
          <i class="bi bi-graph-up-arrow text-primary"></i>
          <span class="fw-bold">BJJ Trader</span>
        </a>
        
        <div class="d-flex align-items-center gap-3">
          <div class="d-flex align-items-center gap-2 bg-dark rounded-pill px-3 py-1 border border-secondary border-opacity-25">
            <span class="status-dot" id="statusDot"></span>
            <span class="small fw-medium text-secondary" id="statusText">Offline</span>
          </div>
          
          <button class="btn btn-sm btn-outline-secondary rounded-circle" id="soundBtn" onclick="toggleSound()">
            <i class="bi bi-bell-fill" id="soundIcon"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Layout -->
    <div class="container-fluid py-3">
      
      <!-- Symbol Scroller -->
      <div class="symbol-scroller mb-3" id="symbolTabs">
        <!-- Javascript will populate this -->
      </div>

      <div class="row g-3">
        <!-- Left Column: Chart & Indicators -->
        <div class="col-lg-9">
          <!-- Chart -->
          <div class="card mb-3">
            <div class="card-body p-0">
              <div id="main-chart" class="chart-container"></div>
              
              <!-- Floating Chart Info (Absolute) -->
              <div class="position-absolute top-0 start-0 p-3" style="pointer-events: none; z-index: 10;">
                <h4 class="m-0 fw-bold" id="currentPriceDisplay">0.00000</h4>
                <small class="fw-medium" id="priceChangeDisplay">--%</small>
              </div>
            </div>
          </div>

          <!-- Indicators Grid -->
          <div class="row g-2 g-md-3">
            <div class="col-12 col-md-3">
              <div class="card h-100">
                <div class="card-body p-3 text-center">
                  <div class="indicator-label mb-1">RSI (14)</div>
                  <div class="indicator-value" id="ind-rsi">--</div>
                  <small class="text-secondary" id="ind-rsi-status">Neutro</small>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-3">
              <div class="card h-100">
                <div class="card-body p-3 text-center">
                  <div class="indicator-label mb-1">MACD</div>
                  <div class="indicator-value" id="ind-macd">--</div>
                  <small class="text-secondary" id="ind-macd-status">--</small>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-3">
              <div class="card h-100">
                <div class="card-body p-3 text-center">
                  <div class="indicator-label mb-1">Tendencia</div>
                  <div class="indicator-value" id="ind-trend">--</div>
                  <small class="text-secondary">EMA 12/26</small>
                </div>
              </div>
            </div>
            <div class="col-12 col-md-3">
              <div class="card h-100">
                <div class="card-body p-3 text-center">
                  <div class="indicator-label mb-1">Volatilidad</div>
                  <div class="indicator-value fs-4" id="ind-atr">--</div>
                  <small class="text-secondary">ATR</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Alerts & Info -->
        <div class="col-lg-3">
          <!-- Desktop Telegram CTA -->
          <a href="https://t.me/BJJTraderAlertas" target="_blank" class="card mb-3 text-decoration-none border-info d-none d-lg-block">
            <div class="card-body d-flex align-items-center gap-3">
              <div class="bg-primary bg-opacity-10 p-3 rounded-3 text-primary">
                <i class="bi bi-telegram fs-4"></i>
              </div>
              <div>
                <h6 class="mb-0 text-white">Canal de SeÃ±ales</h6>
                <small class="text-secondary">Ãšnete gratis en Telegram</small>
              </div>
            </div>
          </a>

          <!-- Recent Alerts -->
          <div class="card h-100" style="min-height: 400px;">
            <div class="card-header bg-transparent border-bottom border-secondary border-opacity-25 d-flex justify-content-between align-items-center py-3">
              <h6 class="mb-0 fw-bold"><i class="bi bi-broadcast me-2 text-danger"></i>SeÃ±ales Recenties</h6>
              <span class="badge bg-secondary bg-opacity-25 text-secondary" id="alertCount">0</span>
            </div>
            <div class="card-body p-2 alert-feed" id="alertsList">
              <div class="text-center py-5 text-secondary opacity-50">
                <i class="bi bi-activity fs-1 d-block mb-2"></i>
                <small>Esperando oportunidades...</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile Telegram FAB -->
    <a href="https://t.me/BJJTraderAlertas" target="_blank" class="fab-telegram d-lg-none">
      <i class="bi bi-telegram fs-4"></i>
    </a>

    <!-- Toast Notification Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <!-- Dynamic Toasts will be injected here -->
    </div>

    <!-- Audio -->
    <audio id="alertSound" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleW1RYHGQa2NiWmJra2hVb4N7f4aWoqaieqdofmNUWW93bGhnZ3N1aV5nb4aBfIF/gYqJkI2GfWdaUFeHlZSLfHZ3dGpnb3V0eIF6bmpoeXd4gYmQlJOahXVkYmN6i5iYmZGOkZ6koaSak4V0amJfZ3R3c25qbHBwdHh3dnt4c3N3gIiFhoWBenVydnh1bXB1d3l9e3l/g4F8eHl8gn15cXFyc3R3fXx5enl2cnF1fIKEhYmKg3t4dXZ5f4B+d3d3eHl4dnV4en19e3h4en+DhISEgXt3dXZ6fX18eXh4eHd4eXp7e3t5eHl7fX5/gH99enh4eXt7e3t6eXh4eHl5eXp6enp6enp7fH19fX59fHt7e3t7e3t7e3t7e3t7e3t7fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8fHx8"></audio>

    <!-- App Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // ================= CONFIGURACIÃ“N =================
      const SYMBOLS = [
        "EURUSD=X", "GBPUSD=X", "USDJPY=X", "USDCHF=X",
        "AUDUSD=X", "USDCAD=X", "NZDUSD=X",
        "EURGBP=X", "EURJPY=X", "GBPJPY=X", "AUDJPY=X",
        "EURAUD=X", "EURCHF=X", "GBPCHF=X"
      ];
      let currentSymbol = SYMBOLS[0];
      let soundEnabled = true;
      let chart, candleSeries, ema12Series, ema26Series;
      let socket;

      // ================= INICIALIZACIÃ“N =================
      document.addEventListener('DOMContentLoaded', () => {
        initSymbolTabs();
        initChart();
        initSocket();
        loadAlertsFromStorage();
      });

      function initSymbolTabs() {
        const container = document.getElementById('symbolTabs');
        container.innerHTML = SYMBOLS.map(sym => `
          <button class="symbol-btn ${sym === currentSymbol ? 'active' : ''}" 
                  onclick="switchSymbol('${sym}')">
            ${sym.replace('=X', '')}
          </button>
        `).join('');
      }

      function switchSymbol(newSym) {
        currentSymbol = newSym;
        document.querySelectorAll('.symbol-btn').forEach(btn => {
          btn.classList.toggle('active', btn.textContent.trim() === newSym.replace('=X', ''));
        });
        if (socket) socket.emit('request_data', { symbol: currentSymbol });
      }

      function toggleSound() {
        soundEnabled = !soundEnabled;
        const icon = document.getElementById('soundIcon');
        icon.className = soundEnabled ? 'bi bi-bell-fill' : 'bi bi-bell-slash';
      }

      // ================= CHARTING (TradingView Lightweight) =================
      function initChart() {
        const container = document.getElementById('main-chart');
        chart = LightweightCharts.createChart(container, {
          layout: { background: { type: 'solid', color: '#1e222d' }, textColor: '#d1d4dc' },
          grid: { vertLines: { color: '#2a2e39' }, horzLines: { color: '#2a2e39' } },
          crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
          timeScale: { borderColor: '#2a2e39', timeVisible: true },
          rightPriceScale: { borderColor: '#2a2e39' },
          autoSize: true, // Responsive
        });

        candleSeries = chart.addCandlestickSeries({
          upColor: '#26a69a', downColor: '#ef5350',
          borderUpColor: '#26a69a', borderDownColor: '#ef5350',
          wickUpColor: '#26a69a', wickDownColor: '#ef5350',
        });

        ema12Series = chart.addLineSeries({ color: '#2962ff', lineWidth: 2, title: 'EMA12' });
        ema26Series = chart.addLineSeries({ color: '#b620e0', lineWidth: 2, title: 'EMA26' });
        
        // Resize observer for advanced responsiveness
        new ResizeObserver(entries => {
            if (entries.length === 0 || entries[0].target !== container) { return; }
            const newRect = entries[0].contentRect;
            chart.applyOptions({ width: newRect.width, height: newRect.height });
        }).observe(container);
      }

      // ================= SOCKET.IO =================
      function initSocket() {
        socket = io();
        
        socket.on('connect', () => {
          document.getElementById('statusDot').classList.add('connected');
          document.getElementById('statusText').textContent = 'Conectado';
          socket.emit('request_data', { symbol: currentSymbol });
        });

        socket.on('disconnect', () => {
          document.getElementById('statusDot').classList.remove('connected');
          document.getElementById('statusText').textContent = 'Reconectando...';
        });

        socket.on('chart_data', data => {
          if(!data.candles) return;
          const candles = data.candles.map(c => ({
            time: c.time, open: c.open, high: c.high, low: c.low, close: c.close
          }));
          candleSeries.setData(candles);
          
          const ema12Data = data.ema12.map((val, i) => ({ time: candles[i]?.time, value: val })).filter(x => x.time && x.value);
          const ema26Data = data.ema26.map((val, i) => ({ time: candles[i]?.time, value: val })).filter(x => x.time && x.value);
          
          ema12Series.setData(ema12Data);
          ema26Series.setData(ema26Data);
          
          // Scale chart logic
          if(candles.length > 0) {
            // Mobile (< 768px): Zoom to last 3 hours
            if (window.innerWidth < 768) {
                const lastTime = candles[candles.length - 1].time;
                const startTime = lastTime - (3 * 60 * 60); 
                chart.timeScale().setVisibleRange({
                    from: startTime,
                    to: lastTime
                });
            } else {
                // Desktop: Standard fit
                chart.timeScale().fitContent();
            }
          } else {
            chart.timeScale().fitContent();
          }
        });

        socket.on('indicators', data => {
          // Update Price Header
          const priceEl = document.getElementById('currentPriceDisplay');
          const changeEl = document.getElementById('priceChangeDisplay');
          
          priceEl.textContent = data.price.toFixed(5);
          priceEl.className = `m-0 fw-bold ${data.change >= 0 ? 'text-success' : 'text-danger'}`;
          
          changeEl.textContent = `${data.change >= 0 ? '+' : ''}${data.changePercent.toFixed(2)}%`;
          changeEl.className = `fw-medium ${data.change >= 0 ? 'text-success' : 'text-danger'}`;

          // RSI
          const rsiEl = document.getElementById('ind-rsi');
          rsiEl.textContent = data.rsi.toFixed(1);
          rsiEl.className = `indicator-value ${data.rsi > 70 ? 'text-danger' : (data.rsi < 30 ? 'text-success' : 'text-light')}`;
          document.getElementById('ind-rsi-status').textContent = data.rsi > 70 ? 'Sobrecompra' : (data.rsi < 30 ? 'Sobreventa' : 'Neutro');

          // MACD
          const macdEl = document.getElementById('ind-macd');
          const isBull = data.macd > data.macdSignal;
          macdEl.innerHTML = isBull ? '<i class="bi bi-arrow-up-right"></i>' : '<i class="bi bi-arrow-down-right"></i>';
          macdEl.className = `indicator-value ${isBull ? 'text-success' : 'text-danger'}`;
          document.getElementById('ind-macd-status').textContent = isBull ? 'Alcista' : 'Bajista';

          // Trend
          const trendEl = document.getElementById('ind-trend');
          const trendBull = data.ema12 > data.ema26;
          trendEl.textContent = trendBull ? 'ALCISTA' : 'BAJISTA';
          trendEl.className = `indicator-value ${trendBull ? 'text-success' : 'text-danger'}`;

          // ATR
          document.getElementById('ind-atr').textContent = data.atr.toFixed(5);
        });
        
        socket.on('price_update', data => {
            if(data.symbol === currentSymbol) {
                 document.getElementById('currentPriceDisplay').textContent = data.price.toFixed(5);
            }
        });

        socket.on('new_alert', alert => {
          addAlertToFeed(alert);
          saveAlertToStorage(alert);
          showToast(alert);
          if (soundEnabled) document.getElementById('alertSound').play().catch(()=>{});
        });
      }

      // ================= ALERT HANDLING =================
      const alerts = [];
      
      function addAlertToFeed(alert) {
        // Prevent duplicates in UI
        const id = `${alert.symbol}-${alert.time}`;
        if (document.getElementById(id)) return;
        
        alerts.unshift(alert);
        if(alerts.length > 50) alerts.pop();
        document.getElementById('alertCount').textContent = alerts.length;

        const container = document.getElementById('alertsList');
        const isBuy = alert.type === 'COMPRA';
        
        const html = `
          <div class="alert-item card p-2 mb-2 ${isBuy ? 'buy' : 'sell'}" id="${id}">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <div>
                <span class="badge ${isBuy ? 'bg-success' : 'bg-danger'} bg-opacity-75 me-1">${isBuy ? 'COMPRA' : 'VENTA'}</span>
                ${alert.strength ? `<span class="badge bg-secondary bg-opacity-50" style="font-size: 0.65rem;">${alert.strength}</span>` : ''}
              </div>
              <small class="text-secondary" style="font-size: 0.7rem;">${alert.time}</small>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span class="fw-bold fs-6">${alert.symbol.replace('=X','')}</span>
              <span class="font-monospace text-light fs-6">E: ${alert.price.toFixed(5)}</span>
            </div>

            ${alert.expiration ? 
              `<div class="text-end mb-1">
                 <span class="badge bg-warning text-dark border border-warning" style="font-size: 0.7rem;">
                   <i class="bi bi-stopwatch me-1"></i>Exp: ${alert.expiration}
                 </span>
               </div>` : ''}

            <div class="alert-details bg-dark bg-opacity-25 rounded p-2 mb-1" style="font-size: 0.75rem;">
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-danger fw-medium">SL: ${alert.stopLoss.toFixed(5)}</span>
                    <span class="text-success fw-medium">TP: ${alert.takeProfit.toFixed(5)}</span>
                </div>
                 <div class="d-flex justify-content-between text-secondary" style="font-size: 0.7rem;">
                    <span>ATR: ${alert.atr ? alert.atr.toFixed(4) : '-'}</span>
                    <span>RSI: ${alert.rsi ? alert.rsi.toFixed(1) : '-'}</span>
                </div>
            </div>

            <div class="small text-secondary text-truncate mt-1 fst-italic">
                <i class="bi bi-info-circle me-1"></i>${alert.reason}
            </div>
          </div>
        `;
        
        // Remove empty state if present
        const emptyState = container.querySelector('.text-center');
        if(emptyState) emptyState.remove();
        
        container.insertAdjacentHTML('afterbegin', html);
        
        // Clean old DOM elements
         if (container.children.length > 50) {
            container.removeChild(container.lastChild);
        }
      }

      function saveAlertToStorage(alert) {
          try {
            let stored = JSON.parse(sessionStorage.getItem('bjj_alerts') || '[]');
            if (!stored.some(a => a.symbol === alert.symbol && a.time === alert.time)) {
                 stored.unshift(alert);
                 if (stored.length > 50) stored = stored.slice(0, 50);
                 sessionStorage.setItem('bjj_alerts', JSON.stringify(stored));
            }
          } catch(e) { console.error('Storage error', e); }
      }

      function loadAlertsFromStorage() {
          try {
            const stored = JSON.parse(sessionStorage.getItem('bjj_alerts') || '[]');
            // Iterate from end to start so they are added in correct order (since addAlertToFeed does prepend)
             for (let i = stored.length - 1; i >= 0; i--) {
                addAlertToFeed(stored[i]);
            }
          } catch(e) { console.error('Storage error', e); }
      }

      function showToast(alert) {
        const isBuy = alert.type === 'COMPRA';
        const colorClass = isBuy ? 'success' : 'danger';
        const toastId = 'toast-' + Date.now();
        
        const toastHtml = `
          <div id="${toastId}" class="toast align-items-center text-bg-dark border-${colorClass}" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
              <div class="toast-body">
                <strong class="text-${colorClass}">${isBuy ? 'ðŸŸ¢ COMPRA' : 'ðŸ”´ VENTA'} ${alert.symbol.replace('=X','')}</strong>
                <div class="small mt-1">${alert.reason}</div>
              </div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
          </div>
        `;
        
        document.querySelector('.toast-container').insertAdjacentHTML('beforeend', toastHtml);
        const toastEl = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
        
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
      }
    </script>
  </body>
</html>
